Code written by Guoyao Shen.
For further explaination, please refer to codes comments.